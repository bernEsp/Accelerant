
<div id="rightColumn">

  <%= render :partial => 'discussion_form' %>


  <!-- Start Discussion Topic links -->
  <% talk_count = Discussion.count(:all, :conditions => {:project_id => params[:id]}) %>
  <%if talk_count > 1 %>
  <fieldset style="background-color:#e9e9e9;border:none;">
    <legend>Jump to discussion topic</legend>
  <% for discussion in @discussions %>
    <!-- <a href='#<%= discussion.id %>'
       onclick="Effect.SlideDown('discussion<%= discussion.id %>');return false;"
       style="font-size:18px;font-weight:bold;color:#000;line-height:24px;">
      <%#= discussion.title %>
    </a> -->
  <%= link_to discussion.title,
    {:controller => "discussion", :id => discussion.id, :action => 'show', :project_id => discussion.project_id},
    :class => 'discussion_links'%><br/>
  <% end %>
  </fieldset>
  <% end  %>

  <!-- End Discussion Topic links -->

  <% discussion = @discussions_desc %>

  <div id="discussion<%= discussion.id %>"  >
  <a name="<%= discussion.id %>"></a><br/>
  <div class="topResponseBox" style="background-color:#f8f8f8;">
    <h1><%= discussion.title %></h1>
  <div class="avatar">
          <% if discussion.user %>
            <%= image_tag discussion.user.avatar.url(:small) %>
          <% else %>
            &nbsp;
          <% end %>
  </div>
  <div class="responseWidget" style="padding-top:15px;"><%= discussion.content %></div>
  </div>
          <div id="topResponse<%= discussion.id %>" style="padding-top:15px;clear:both;" >
              <% form_for :comments,
		#:update => "latestresponse",
		#:complete => "new Effect.Highlight('latestresponse', { duration: .5 })",
		:html => {:id => "my_form", :multipart => true},
		:url =>{:controller => 'comments', :action => 'create' } do |f| -%>
        <div class="avatar">
          <% if self.current_user.avatar_file_name %>
          <%= image_tag self.current_user.avatar.url(:small) %>
          <% end %>
	</div>
        <div class="topResponseBox">
          <h1>Post Your Response:</h1>
          <div class="responseWidget">
          	<%= f.text_area :comment, :size => "60 x 10", :class => 'rich_text_editor' %><br/>
				Upload a photo or file:<br/>
			<%= f.file_field :photo %>
			<% if logged_in? %>
			<%= f.hidden_field :user_id, :value => self.current_user.id %>
			<% end %>
			<%= f.hidden_field :project_id, :value => params[:id] %>
                        <%= f.hidden_field :discussion_id, :value => discussion.id %>
			<div class="postButton" style="margin-top:-20px;">
			<%= submit_tag "Post Your Comment", :style => "margin-right:50px;" %>
                        </div>
          </div>


        </div>


      <% end -%><!-- form for -->
  </div>
  
          
  
  
    <div id="responses">
    <div class="clientMainEntry" id="latestresponse"></div>
    	<!-- Start comments -->
        <% @latest_postings_redux = Comment.find(:all, :conditions => {:discussion_id => discussion.id }, :limit => 20, :order => "id DESC", :include => :user)  %>
		<% for comment in @latest_postings_redux %>
		<% not_visible = CommentAssignments.find(:last, :conditions => {:user_id => self.current_user.id, :comment_id => comment.id })%>
		<% my_project = Project.find(:last, :conditions => {:id => params[:id]}) %>
		<% if (!not_visible && !my_project.one_to_one)  %>
		<div class="clientSubComment" id="commentSub<%= comment.id%>"><a name="#<%=comment.id%>"></a>
	      <div class="subCommentAvatar">
			<% if comment.user.avatar_file_name %>
				<%= image_tag comment.user.avatar.url(:small) %>
			<% end %>
			</div>
	     <div class="clientSubCommentText" >
		 <p>	

			<strong><%=h comment.user.name %></strong>
		<%=comment.comment %>
		<% if comment.photo_content_type %>
		<% if comment.photo_content_type =~ /image.*/  %>
			<a href='<%=comment.photo.url%>' target="_blank">
			<%= image_tag comment.photo.url(:thumb), :style => "margin-left:40px;" %>
			</a>
		<% else %>
			<p><a href='<%=comment.photo.url%>' target="_blank">View attached file here.</a><%= image_tag "download.png"%></p>
		<% end %>
		<% end %>
		<br/>

		<span>- Posted <%= time_ago_in_words(comment.created_at)%> ago </span>
			| <%= link_to_remote 'Add Comment',
			:url => { :controller => 'plain', :action => 'sub_comment_form', :id => comment.id},
			:complete => "new Effect.SlideDown('subCommentForm#{comment.id}', { duration: .5 })",
			:onclick => '',
			:update => "subCommentForm#{comment.id}" %> 
			<% if (comment.user.id == self.current_user.id) || self.current_user.admin %>
				| <%= link_to_remote "Delete", 
				:confirm => "Are you sure you want to delete this?",
				:url => {:controller => 'plain', :action => 'drop_comment', :id => comment.id},
				:complete => "new Effect.Fade('commentSub#{comment.id}', { duration: 2 })",
				:update => "commentSub#{comment.id}" %>
			<% end %>
			
			
			
			
		<div id="subCommentForm<%= comment.id %>"></div>
		<div id="reclaimer<%= comment.id %>"></div>
		<% @replies = Replies.find(:all, :conditions => { :comment_id => comment.id}, :order => "id DESC", :include => :user) %>
		<% for replies in @replies %>
			<% #user = User.find(:last, :conditions => {:id => replies.user_id}) %>
			<p style="background-color:#cdd7de;margin:8px;padding:2px;" id="reply<%= replies.id%>"><%= image_tag replies.user.avatar.url(:smaller) %>&nbsp;&nbsp;<%= replies.content %>
				<% if replies.media_file_name %>
					<% if replies.media_content_type =~ /image.*/  %>
						<a href='<%=replies.media.url%>' target="_blank"><%= image_tag replies.media.url(:small), :style => "margin-left:40px;" %></a>
					<% else %>
						<a href='<%=replies.media.url%>' target="_blank">View attached file here.</a><%= image_tag "download.png"%>
					<% end %>
				<% end %>
				posted by 
				<% if replies.user.name == self.current_user.name %>
					you 
				<% else %>
					<%= replies.user.name%>  
				<% end %>
				<%= time_ago_in_words(replies.created_at) %> ago
				<% if (replies.user.id == self.current_user.id) || self.current_user.admin %>

					| <%= link_to_remote "Delete", 
					:confirm => "Are you sure you want to delete this?",
					:url => {:controller => 'plain', :action => 'drop_reply', :id => replies.id},
					:complete => "new Effect.Fade('reply#{replies.id}', { duration: 2 })",
					:update => "reply#{replies.id}" %>
				<% end %>
				</p>
		<% end %>
			<div id="<%=dom_id(comment)%>">
			</div>
		</div>
		<hr noshade="noshade"/>
    </div>
	<% else %>
		<% if (my_project.one_to_one?) && (comment.user.id == self.current_user.id || comment.user.admin? || comment.user.moderator?) %>
			<div class="clientSubComment" id="commentSub<%= comment.id%>"><a name="<%=comment.id%>"></a>
		      <div class="subCommentAvatar">
				<% if comment.user.avatar_file_name %>
					<%= image_tag comment.user.avatar.url(:small) %>
				<% end %>
				</div>
		     <div class="clientSubCommentText" >
			 <p>	

				<strong><%=h comment.user.name %></strong>
			<%=comment.comment %>
			<% if comment.photo_content_type %>
			<% if comment.photo_content_type =~ /image.*/  %>
				<a href='<%=comment.photo.url%>' target="_blank">
				<%= image_tag comment.photo.url(:thumb), :style => "margin-left:40px;" %>
				</a>
			<% else %>
				<p><a href='<%=comment.photo.url%>' target="_blank">View attached file here.</a><%= image_tag "download.png"%></p>
			<% end %>
			<% end %>
			<br/>

			<span>- Posted <%= time_ago_in_words(comment.created_at)%> ago </span>
				| <%= link_to_remote 'Add Comment',
				:url => { :controller => 'plain', :action => 'sub_comment_form', :id => comment.id},
				:complete => "new Effect.SlideDown('subCommentForm#{comment.id}', { duration: .5 })",
				:onclick => '',
				:update => "subCommentForm#{comment.id}" %> 
				<% if (comment.user.id == self.current_user.id) || self.current_user.admin %>
					| <%= link_to_remote "Delete", 
					:confirm => "Are you sure you want to delete this?",
					:url => {:controller => 'plain', :action => 'drop_comment', :id => comment.id},
					:complete => "new Effect.Fade('commentSub#{comment.id}', { duration: 2 })",
					:update => "commentSub#{comment.id}" %>
				<% end %>

				


			<div id="subCommentForm<%= comment.id %>"></div>
			<div id="reclaimer<%= comment.id %>"></div>
			<% @replies = Replies.find(:all, :conditions => { :comment_id => comment.id}, :order => "id DESC", :include => :user) %>
			<% for this_reply in @replies %>
				<% if (this_reply.user.id == self.current_user.id) || (this_reply.user.admin || this_reply.user.moderator) || self.current_user.admin || self.current_user.moderator %>
				
				<p style="background-color:#cdd7de;margin:8px;padding:2px;" id="reply<%= this_reply.id%>"><%= image_tag this_reply.user.avatar.url(:smaller) %>&nbsp;&nbsp;<%= this_reply.content %>
					<% if this_reply.media_file_name %>
						<% if this_reply.media_content_type =~ /image.*/  %>
							<a href='<%=this_reply.media.url%>' target="_blank"><%= image_tag this_reply.media.url(:small), :style => "margin-left:40px;" %></a>
						<% else %>
							<a href='<%=this_reply.media.url%>' target="_blank">View attached file here.</a><%= image_tag "download.png"%>
						<% end %>
					<% end %>
		
					<br/>
					posted by 
					<% if this_reply.user.name == self.current_user.name %>
						you 
					<% else %>
						<%= this_reply.user.name%>  
					<% end %>
					<%= time_ago_in_words(this_reply.created_at) %> ago
					<% if (this_reply.user.id == self.current_user.id) || self.current_user.admin %>
						| <%= link_to_remote "Delete", 
						:confirm => "Are you sure you want to delete this?",
						:url => {:controller => 'plain', :action => 'drop_reply', :id => this_reply.id},
						:complete => "new Effect.Fade('reply#{this_reply.id}', { duration: 2 })",
						:update => "reply#{this_reply.id}" %>
					<% end %>
					</p>
					<% end %>
			<% end %>
				<div id="<%=dom_id(comment)%>">
				</div>
			</div>
			<hr noshade="noshade"/>
	    </div>
		
	<% end %>
  <% end %>
<% end %>
    </div><!-- responses -->
</div>

  

</div> <!-- right column -->
 	<% if self.current_user.admin %>
	<%= link_to "CSV", :controller => 'comment', :action => 'export_to_csv', :id => params[:id], :format => 'csv' %>
	<% end %>  
 
	      <!-- <div class="viewAll">- <a href="#">View All Comments</a></div> -->
 
<%#= periodically_call_remote(:url => {:controller => 'plain', :action => 'showlatest', :id => params[:id]}, :frequency => '30', :update => 'responses')%>