<%
  require 'net/imap'
  require 'tmail'


#UserMailer.check_mail
    #UserMailer.deliver_test_email()
    imap = Net::IMAP.new('secure.emailsrvr.com')
imap.login('study@blognogresearch.com', 'masterkey')
imap.select('INBOX')
imap.search(["NOT", "DELETED"]).each do |message_id|
  msg = imap.fetch(message_id,'RFC822')[0].attr['RFC822']
mail = TMail::Mail.parse(msg)
body = mail.body
subject = mail.subject
from = mail.from

  @emailing_user = User.find(:last, :conditions => {:login => subject})

  %>

To: <%= mail.to  %><br/>
From: <%= from  %><br/>
Subject: <%= subject  %><br/>
<% if @emailing_user %>
Going to: <%= @emailing_user.email  %><br/>
<% else %>
<% UserMailer.deliver_not_found(from, subject) %>
<%end%>

<%= body  %><br/>

<%
  imap.store(message_id, "+FLAGS", [:Deleted])
end
imap.expunge()


%>



